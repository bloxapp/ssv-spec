package types

import (
	"encoding/hex"
	"testing"

	apiv1capella "github.com/attestantio/go-eth2-client/api/v1/capella"
	"github.com/attestantio/go-eth2-client/spec"
	"github.com/attestantio/go-eth2-client/spec/capella"
	ssz "github.com/ferranbt/fastssz"
	"github.com/stretchr/testify/require"
)

func TestConsensusData_GetBlockData(t *testing.T) {
	blkHexJson := "7b22736c6f74223a223132222c2270726f706f7365725f696e646578223a223130222c22706172656e745f726f6f74223a22307830313032303330343035303630373038303930613031303230333034303530363037303830393061303130323033303430353036303730383039306130313032222c2273746174655f726f6f74223a22307830313032303330343035303630373038303930613031303230333034303530363037303830393061303130323033303430353036303730383039306130313032222c22626f6479223a7b2272616e64616f5f72657665616c223a223078303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c22657468315f64617461223a7b226465706f7369745f726f6f74223a22307830313032303330343035303630373038303930613031303230333034303530363037303830393061303130323033303430353036303730383039306130313032222c226465706f7369745f636f756e74223a22313030222c22626c6f636b5f68617368223a22307830313032303330343035303630373038303930613031303230333034303530363037303830393061303130323033303430353036303730383039306130313032227d2c226772616666697469223a22307830313032303330343035303630373038303930613031303230333034303530363037303830393061303130323033303430353036303730383039306130313032222c2270726f706f7365725f736c617368696e6773223a5b5d2c2261747465737465725f736c617368696e6773223a5b5d2c226174746573746174696f6e73223a5b7b226167677265676174696f6e5f62697473223a2230783030303030303030303030303030303030303030303030303030303030303034222c2264617461223a7b22736c6f74223a223132222c22696e646578223a2233222c22626561636f6e5f626c6f636b5f726f6f74223a22307830313032303330343035303630373038303930613031303230333034303530363037303830393061303130323033303430353036303730383039306130313032222c22736f75726365223a7b2265706f6368223a2230222c22726f6f74223a22307830313032303330343035303630373038303930613031303230333034303530363037303830393061303130323033303430353036303730383039306130313032227d2c22746172676574223a7b2265706f6368223a2231222c22726f6f74223a22307830313032303330343035303630373038303930613031303230333034303530363037303830393061303130323033303430353036303730383039306130313032227d7d2c227369676e6174757265223a223078303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030227d5d2c226465706f73697473223a5b5d2c22766f6c756e746172795f6578697473223a5b5d2c2273796e635f616767726567617465223a7b2273796e635f636f6d6d69747465655f62697473223a2230783030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c2273796e635f636f6d6d69747465655f7369676e6174757265223a223078303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030227d2c22657865637574696f6e5f7061796c6f6164223a7b22706172656e745f68617368223a22307830303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c226665655f726563697069656e74223a22307830303030303030303030303030303030303030303030303030303030303030303030303030303030222c2273746174655f726f6f74223a22307830303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c2272656365697074735f726f6f74223a22307830303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c226c6f67735f626c6f6f6d223a2230783030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c22707265765f72616e64616f223a22307830303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c22626c6f636b5f6e756d626572223a22313030222c226761735f6c696d6974223a2231303030303030222c226761735f75736564223a22383030303030222c2274696d657374616d70223a22313233343536373839222c2265787472615f64617461223a223078222c22626173655f6665655f7065725f676173223a2230222c22626c6f636b5f68617368223a22307830303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c227472616e73616374696f6e73223a5b2230783130316238383334373066316362376530613734353631626535396530386136656666366165646433343038633139306664333539663062666236323864323436313335346237666534666461643462386537326238373735636434346533333961643662356632326138663533633431386264613262303132303061303766316665336430313062626239366635636130643439313931393233373063313562633436656434353563373937623162313131353462653335393633386639653438373132313138326661653033613764323630313265643763383562363461363361613564353661393861633538396639393530613966356266316134326331656561323435613938663266346537343363356638656163313538343839333130343835336463316235353736383236313536623337316135306335396263623233386430373934613138356463303831366462643863313061306230653162386662653031633465386464373139663165346539623264656438363133663837663164303165336561323865393331316431333533303162326431323630653438313137383965316563626333336535373333343666346461393466346332373265323165323362316434313437303634323963376630623430633364653234333839343334396334613539656365373931653566643038363839376165663831666332336534643535626235326232383137346333666139663263343464333730666262616331646565353631663132303536306333646461333461373331643436313866643232643539356237323565666138376262363266386639336264376439303663343738326136343765326362313465643239336535386263373933383532303538616235653666336466373662333065393931303262383263386537643030356531623637356663373462393530333236313663353930666630386461373130646430383562653537306363306232633133383931363235623434623562336531383436363036633339616433396262373262222c2230783462356564666635386366393539363965616430343730616238393764613663396436396235313765303766643465643866613438633134323834613561303630656362373435663636636631626535356662343930356436326438643337363836356637643264313831363834346663343731396635643739616239303534373464303066363261656436363932653561393362653162333237343061383038336663326136316230653166633133616434303934313064333766336362306135323735633936366162616230313530343763313532353163643330316364333161376232613035303266376639353365363732643631363036363136623136643531313731363330363466623333643937656235363666376663653566303164333833333334336331633937653632323166396630373938343135663361346238376664343732653533613234633161313031653164643535633866363563326330663463636334623436613133336664613439646235646261393636333162346366643161303536363265343261386531356132366433313438613730626533303563383566383764616534323137666239313439386334303938623934366139303432333535393638623736356532653632626230636632366435396535333463336166383739356661306634613434656430643339643235386163643933346333343136653464346137333865616134373335323664393962656530333737363564356636303334633833306562373636656630363761313436383633306662623635623763356138363230313766653834643464313936316639306333376631386134626432353039666532653936636231653236393731393030653230323935633861396539656437376233343864343530396138343235303930333138626535633964326263646133366264666162623731626662333637353537393466373863383737646632383235626437333661333538393333616637376561653665646637303165643765663136386635376636373764663334343564383963356565666337383331383465616464333838366663666437356635663134326263313039303461303139616364663738363163616137653066626133653738333162306135343961353663306631373465383063666662383939323334366464663763653465656666396533333535333164663364666635376435663533396263306433656163353766373061386639373365303836346338376232356333653062656137326530356564613861313230313738313836646662666161396130306639303466323361222c22307834353261663939303937356333626361666565376264653437333866646633326238343739626530653965333062313162306363626633316136663838346634303938653437373539623761336562376437626430636661323531306464363534623238643636343639366163613938376635356337626665373362653163633730613736386364623235393461313361373633646262393931313836623862386232653931333835376161646330386639343032333964303361306231383161653834396435353764613562353462666339363632333136393062623436363065303833636461653238636166386564333365336636363637323737326561383237323533343231626164653031336166353761323930613931356462633737376632616663636439636232396532363065636335656135346364336131653235636636366632393337663830363162336261366231656266333132393536386631366533646430346435633530393932636333343866336536313561663334366462663263313434616562313939333264636662666630323231666165306564393730366235333234353137363633306430313162396364326438363330383438616231313936636639613363633064393433393264663432393562653234366530616332343534356332373135613430646362633537616162666664306138366163656333363261666661663162616663356337356237636132383639386131616331346561326338646566386163316133326433626636356239386161633764306362366664393365356666313632373461643664306565646637373336393466323966633761323334646565626338393365346365613461353438336438373665346633353031396436613632663163343037373339623638623761396635343038623466623835343533343334346662666665333233396665623137633065376163323639623434376263363234363537396531323038623639303437353165656163623938356362643433626237373932646530623432386631343736333031633437396133393232663631663635306338323938666230623735383462353263376266636634646665353133333561623638643537316335383135666337386437373233343662306231336462626238393036663037366130343532653765376134313465303035646333376366656538353831306563636162353939396532643433653133373039626636366538613839333661343238333838356231353831313530353037383964336234643963386463383032366163373230303639643738643437646435653138333033326639633533643463353736343066636436323037313138643937333866303063643564646635383766336137633430316439323361613266623038646261313736383732383030316162633334333663633262356366393738623535386165353861303537383334346537343634636430306537313931333563373032343465326661663132363435373161383939393738396332366634303137353365343239613131333566313839303665626566313965313232343839363232373338373234613634323463616433363362656434333330346331323835633864613438323466656337356437633531623061333430373064386239373665386538633866643530393038613765343430303932646464643937306664353537393365326134343436333432626433646166356239363232303937376438663063222c223078303837373434383639343939333731376138396335376236333634303631326163346230323538636235666464613461333131363530633633316333356337333133623664326130393466646232303738353764393435303063333761623230656130616135346166393531666230343538346133376238353739383163366431333932326539356366656362373062363961623961353765653663313363636638616133386335326465303038656331366439303930616134626631356462326634616663646262316266343932306566653561316165656666326339343964343334363064363738333761663837626364666664396539373233343063623430646536643837666131316438336262666232396539376566323530393039376538646563363961313331383133326135646437643935633163316531336363383564333761333363396637643532333739623461343762663838393930336338663365626432383030353236643039313665316161643030653032623638326535356263323836356333666634636530636336616164316264376438653239303165613533663361356532633032356462623961303066306365383835383363316462643364343931656430346261383236306463303666646238613931363265303232633735653966303537646130616265643533376233343231346466323334653166386232366537333734636661353437303237326566303366376234316637656430363763346336303131633861313762326536353334306533366166383165636238363432303735356665356130343133343935653136666162656533663965353532346162376231326133636666653230623164663762653332343334643764613366623166336539623136663432613466353530353031313230303336623139333730316163396562366637363063326461373065333137356136366231303436336534336330343432613536323137636137636432356664623436663365666632386366316264666531623765623362663965383561643866666465323037353239633962623130393464626165346462303461346266663635373163393835626436323963646332623738663733396563613636393466333266646564363934343230323835393237373734303236376435646334633166373464646431343031633664353134636532336238383537323363343631383738396235633264646566666563323137396265386465633133343763613465626564356538626231306437643137643431633937303961393738666336313839663063336434396431623766343162663866316463313132663265636538346236633661363837663434623935653632643237346638396661303762643064336664643365653261393732333365333633333239656637303936616535613435623239383238353965393833663564393839613932386539623838353739333038656365323339316462646533373862383161353464333862336638313232356435396638626235313162613765623539303135346365623832353862383034623664613938623361663666333935663562336631643132663566643363323965663534663331636365613061333665633264616563306138373033306461626138643037393039336464646531373837316334616131613764633364626434643736306265323135326463323530636132626261333461353564616632353762396533373034633365653234343038313532346362316165376332326130643232663163363562383862316535333465613163623866373563656134613763303364363738366638353332373837366461373264666631643464303439623531656363313031323432373961306362633135316537366464643437356366336466656564653539613930326634633731343537383662353939336338626638303136323635656333363239386232376430633661323163373438346663303161386631346338633238376431346162383637383965333436393966646235376636633433343836663066643930313366326632633632633630623735623164633365346433386136663763303665373032396638373461323034623035396438333466666234346339396638343361653333656430393530222c2230783235393331306435313334643232653065663432633336383662326164616463366364316165376437383336616337316136396438626132643032643031353263333230363130633132633537636261313832633564316532313139386537383762323164306335323231303661613832343365633939346334656130623739353961333236396431333536366633643061336562356564323736643965323262333366633132653236636166646530346232346563306664393034353564633236643330613966633235353838623736323638316361363961656363313965373937316464346364303633643465333165653939663363383230313565643961373065353862396437636439613864653338656261393063656666633632396537643663303665346632666539636434356261653535373635326665353863633962653534646539613939346266313463336263653738376131303637373834313666626539363665393565353161333562613738643364633465346637353531653237393161663030643530333632343933363937643535656136373138626132663038396564613333306532363130306662356164626239333961666166373439383237393534313434323237313265383536306365633337326561663161353662353062613465303065343262313435353337653934653838656464643764323030643031353365646236646363313265623239383636366230616566396561343935666363666461303662376166666537323237626365623431643961633964643135306466383634326364623131646635616239326236393632396236613563636463376261393262366366313231373232313730353764323931623266646336663130346538363631376265316237666666656233366166353961303138663530633035356532346566396236646166663833393038336263396466656165393130316636616666343966383038663630333833343830326431363032383363643731623237356266393765623439663536313232313563633866653933383735222c2230786661303832616462353166663064636137356666353762613738353264373934323834646235623864343938303032613832316535666332633537613237636331666535393166313238363038393562303035376263373565636266663938323462623436653261663036613738356236616466613965333266343964363233353737366333626361636531386233333063656331313236616332626235663336373933333930333738313765616235333666656432396665356336326566373930636237343839336631353234323830623031313165323466633031373231333064303061383833363165363335313165623536613936653535326430326334393434353434633139333138396131353238343463613439636164616533386237343234343236613734643631373633373136613036386261356361396633626463326530653962363434663166326530323539366264336634343662623966313364666231386164326339613262613937373731626239393466383031616666653265386464613864363338653336366335623832363363633839316138613335653532633739663038353662666561663037313962643162666235346163633436373738336236633038653535343931643339623230663231383334323939313338316333386433353761343635396261663864343464646635303435643766313136626363353566373863323861306463313030643036646666343465363339623865376164663936373831366330336465353465636364663966363430326132383036383839643263643938306633346535313937373731663133663166613662386337633733323033313636346262363735666631326436343261653632343539653932623163633238633632333439653136333638353062386133666634313165316631346230393766376661336232336561613137336431376131336630373033656563643733353861613632333035373332356565643338316132626131336335306131336133643861646161643032393539363064393235373039643665376362313031653839346439616538646233646362383261343535373062366530326162363861613465613934663837373961396334356135353939222c2230783731656133653965633761633861313434373533656333386537383430316231346234383961373932363664643035323761343530356164636135383466653734303664396637663035656634366432363233383466626631633036303766373435613430363831643438353561613334633337333735623263663763393964343662366165346533616139656532303937383264636539643136376262666637393638366535393432366130353133623935313831386565303261396561356564386263643066393931663436656565343463366538326663366430373832336139663434663266643762666130653235306436363939636637616432353737656239656166306464396231353935636630313833383363336434353935366535303866613938326262623737343435323261303362616335636261323266353861343138303166353739343334313236663562383636646363366361303435346539626531633766326636363439323534663363633039313432303638663431326435643435346234653464356235346534353937313935353066326466313930316131383436376439643532393765643461396565646239663430326632626664346264326535306162363937656135626566356537653830383236353062383233363335613466306635356331383731326430663464333635383234633739383237643435343432356165633062346561363536316365336631633534313161623464666632366532343132373931636461613238626636633866613533616634313238323863353939643738373635303866373866326338326565363765383335373934376336383438616631343366633564323034303930343939323563643162313934323434343636373131636537633334613732613136353339323536346239366532383034303661393564613932376431346562626236623939396566343436643561643439383831633231396461633861643032643939346530353935363965393162383466323131613463333961336662643539346138633833356161353937366530633838393964383161356162616131343330313636326239653134666239366561383938363261643839386364376437376263643235343766306634303437316638366434613466323665343237346632653935666439623262363034646538363762653935363330623165613663653435626137396163633831623938363630356534366163646132303862643333303266666363366538336639316266663833363262336639363431636130323237643862333133343165333230303033222c2230783262326163663165376530343362326333386561313735306136633331663137346230613862303031333765633365656132346564396664663937396266303465643932336132636635636330356139616366363937643237636364623261393033613438343637323963643962326565616434313464613938336434663562666430666634663265376562373539383865353863336136333563323731222c2230786365306333623331313433663164363839383764656161633836613165303739646562303762336432643439376465356562653864393434383665396137623330306336393136323161363862336166346665653738316337633035613933313132336639313030353464303936633265313534393530643332613236633338656462373064646135306132343262653464313563653630633236353736376231343130313163643834616135383563336166373938666331656235656136336539336530613432366333653134363866343032663765363466323032383161346264373363633132333431373466313736326139613431393839663537303939373033366338383562316664626639633831353361316431396166623635323661313233636136613266653665393863363030396638343339663662366565613838313435336363353865663334343333386666643034373833636539633238633265333733383132613635313537363433663637396564393961623335663430323465366565333138373765353336623033633338363136666363633939333336353134336464616666636533396338303562333931363734303730653939336336343634313536303433613834323636383630633736396465323138626235663536393866346337613962373431343235333563626363303864356233663734376362663661376466626236633762306363633538616634383836626334343135353834393665396338346438303636303131373737376630316364623834633061326433623066326438613665616366663561306535356264316265363338376333373933616538663532333163353936393761653931343839346134396233616531336133613132346362663663656133336237656235373563663663643133653630373364646634643033336133663837333636633237303839616663303337303765663961343463383238333838373333643730663039626330386465353734643037636631393366306132366130386365383235336266646232366435333036363332303132633664616531393437383364656233316237326163333562626435376630376631363637373436643835663564356232313332623838356638636230323036393439373830663934303633303733393664633765636537393338323235666335613535633635656433363038633237663636386261396230383837353937396532343936353564313561346333643737623134333361623236663536643830653263613931373864383835303165653638326131346430376231373633356539393638646132643938616139656234613561653633396534326565643063373733353331336433333038666430373935383964356362326464333831613932393866363733323539373661366463643365333866383336653462633331303638383566363334386335376339306265616464376362636131373537306239303133306161616463376562306564326266623937633563386137393164306236623237333664343362306634343439303934343965366561333262613730366464666532386334303761383565383265336632323036343639366432666437623337623333653031653030313661643931303437663935663063663563356436616263386664373639386334313535633239306131613164623834326537376536353663363961643862633036636561396530306461646265633838366361363461663566653330343565626338633534396266323365373163363334663032646138623235303631386331363961353465346166343564373939663264653637343762646530313339356131336631613630356539626535222c223078396365643034613531653737656430373330663334323035373131363465613532343761363730623936326562663662343533363630373438636135225d2c227769746864726177616c73223a5b7b22696e646578223a2232222c2276616c696461746f725f696e646578223a2233222c2261646472657373223a22307830303031303230333034303530363037303830393061306230633064306530663130313131323133222c22616d6f756e74223a2231303030303030303030303030303030303030227d5d7d2c22626c735f746f5f657865637574696f6e5f6368616e676573223a6e756c6c7d7d"
	blkBytes, err := hex.DecodeString(blkHexJson)
	require.NoError(t, err)

	var blk capella.BeaconBlock
	require.NoError(t, blk.UnmarshalJSON(blkBytes))

	marshalSSZ, err := ssz.MarshalSSZ(&blk)
	require.NoError(t, err)
	require.NotNil(t, marshalSSZ)

	expectedRoot, err := blk.HashTreeRoot()
	require.NoError(t, err)
	require.NotNil(t, expectedRoot)

	t.Run("successfully get block data", func(t *testing.T) {
		cd := &ConsensusData{
			Duty:                       Duty{},
			Version:                    spec.DataVersionCapella,
			PreConsensusJustifications: nil,
			DataSSZ:                    marshalSSZ,
		}
		vBlock, hashRoot, err := cd.GetBlockData()
		require.NoError(t, err)
		require.NotNil(t, vBlock)
		require.NotNil(t, hashRoot)
		require.Equal(t, vBlock.Capella.Slot, blk.Slot)

		bdRoot, err := hashRoot.HashTreeRoot()
		require.EqualValues(t, expectedRoot, bdRoot)
	})

	t.Run("fail on unmarshal ssz", func(t *testing.T) {
		cd := &ConsensusData{
			Duty:                       Duty{},
			Version:                    spec.DataVersionCapella,
			PreConsensusJustifications: nil,
			DataSSZ:                    nil,
		}
		_, _, err := cd.GetBlockData()
		require.Error(t, err)
		require.EqualError(t, err, "could not unmarshal ssz: incorrect size")
	})

	t.Run("unknown version", func(t *testing.T) {
		cd := &ConsensusData{
			Duty:                       Duty{},
			Version:                    spec.DataVersionBellatrix,
			PreConsensusJustifications: nil,
			DataSSZ:                    nil,
		}
		_, _, err := cd.GetBlockData()
		require.Error(t, err)
		require.EqualError(t, err, "unknown block version bellatrix")
	})
}

func TestConsensusData_GetBlindedBlockData(t *testing.T) {
	blkHexJson := "7b22736c6f74223a223132222c2270726f706f7365725f696e646578223a223130222c22706172656e745f726f6f74223a22307830313032303330343035303630373038303930613031303230333034303530363037303830393061303130323033303430353036303730383039306130313032222c2273746174655f726f6f74223a22307830313032303330343035303630373038303930613031303230333034303530363037303830393061303130323033303430353036303730383039306130313032222c22626f6479223a7b2272616e64616f5f72657665616c223a223078303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c22657468315f64617461223a7b226465706f7369745f726f6f74223a22307830313032303330343035303630373038303930613031303230333034303530363037303830393061303130323033303430353036303730383039306130313032222c226465706f7369745f636f756e74223a22313030222c22626c6f636b5f68617368223a22307830313032303330343035303630373038303930613031303230333034303530363037303830393061303130323033303430353036303730383039306130313032227d2c226772616666697469223a22307830313032303330343035303630373038303930613031303230333034303530363037303830393061303130323033303430353036303730383039306130313032222c2270726f706f7365725f736c617368696e6773223a5b5d2c2261747465737465725f736c617368696e6773223a5b5d2c226174746573746174696f6e73223a5b7b226167677265676174696f6e5f62697473223a2230783030303030303030303030303030303030303030303030303030303030303034222c2264617461223a7b22736c6f74223a223132222c22696e646578223a2233222c22626561636f6e5f626c6f636b5f726f6f74223a22307830313032303330343035303630373038303930613031303230333034303530363037303830393061303130323033303430353036303730383039306130313032222c22736f75726365223a7b2265706f6368223a2230222c22726f6f74223a22307830313032303330343035303630373038303930613031303230333034303530363037303830393061303130323033303430353036303730383039306130313032227d2c22746172676574223a7b2265706f6368223a2231222c22726f6f74223a22307830313032303330343035303630373038303930613031303230333034303530363037303830393061303130323033303430353036303730383039306130313032227d7d2c227369676e6174757265223a223078303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030227d5d2c226465706f73697473223a5b5d2c22766f6c756e746172795f6578697473223a5b5d2c2273796e635f616767726567617465223a7b2273796e635f636f6d6d69747465655f62697473223a2230783030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c2273796e635f636f6d6d69747465655f7369676e6174757265223a223078303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030227d2c22657865637574696f6e5f7061796c6f61645f686561646572223a7b22706172656e745f68617368223a22307830303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c226665655f726563697069656e74223a22307830303030303030303030303030303030303030303030303030303030303030303030303030303030222c2273746174655f726f6f74223a22307830303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c2272656365697074735f726f6f74223a22307830303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c226c6f67735f626c6f6f6d223a2230783030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c22707265765f72616e64616f223a22307830303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c22626c6f636b5f6e756d626572223a22313030222c226761735f6c696d6974223a2231303030303030222c226761735f75736564223a22383030303030222c2274696d657374616d70223a22313233343536373839222c2265787472615f64617461223a223078222c22626173655f6665655f7065725f676173223a2230222c22626c6f636b5f68617368223a22307830303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c227472616e73616374696f6e735f726f6f74223a22307863316335316464393431626161613539656632366637313431646336663162383865366333306533396338313931383966636235313565386263623431373333222c227769746864726177616c735f726f6f74223a22307864363036383539333762666639343639373935313136336334366366393134336562663264386239303130616139343363623334616135376231623534346538227d2c22626c735f746f5f657865637574696f6e5f6368616e676573223a6e756c6c7d7d"
	blkBytes, err := hex.DecodeString(blkHexJson)
	require.NoError(t, err)

	var blk apiv1capella.BlindedBeaconBlock
	require.NoError(t, blk.UnmarshalJSON(blkBytes))

	marshalSSZ, err := ssz.MarshalSSZ(&blk)
	require.NoError(t, err)
	require.NotNil(t, marshalSSZ)

	expectedRoot, err := blk.HashTreeRoot()
	require.NoError(t, err)
	require.NotNil(t, expectedRoot)

	t.Run("successfully get blinded block data", func(t *testing.T) {
		cd := &ConsensusData{
			Duty:                       Duty{},
			Version:                    spec.DataVersionCapella,
			PreConsensusJustifications: nil,
			DataSSZ:                    marshalSSZ,
		}
		vBlock, hashRoot, err := cd.GetBlindedBlockData()
		require.NoError(t, err)
		require.NotNil(t, vBlock)
		require.NotNil(t, hashRoot)
		require.Equal(t, vBlock.Capella.Slot, blk.Slot)

		bdRoot, err := hashRoot.HashTreeRoot()
		require.EqualValues(t, expectedRoot, bdRoot)
	})

	t.Run("fail on unmarshal ssz", func(t *testing.T) {
		cd := &ConsensusData{
			Duty:                       Duty{},
			Version:                    spec.DataVersionCapella,
			PreConsensusJustifications: nil,
			DataSSZ:                    nil,
		}
		_, _, err := cd.GetBlindedBlockData()
		require.Error(t, err)
		require.EqualError(t, err, "could not unmarshal ssz: incorrect size")
	})

	t.Run("unknown version", func(t *testing.T) {
		cd := &ConsensusData{
			Duty:                       Duty{},
			Version:                    spec.DataVersionBellatrix,
			PreConsensusJustifications: nil,
			DataSSZ:                    nil,
		}
		_, _, err := cd.GetBlindedBlockData()
		require.Error(t, err)
		require.EqualError(t, err, "unknown blinded block version bellatrix")
	})
}
